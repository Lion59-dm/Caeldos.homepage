<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDMeSWp-UbFv_jYstUhbB1kkP-Ite-IHM8",
  authDomain: "dnd-caeldos.firebaseapp.com",
  databaseURL: "https://dnd-caeldos-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dnd-caeldos",
  storageBucket: "dnd-caeldos.firebasedestorage.app",
  messagingSenderId: "940131839058",
  appId: "1:940131839058:web:2484beb5ffad8fcfd3438b"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- Left Panel Inputs ---
document.querySelectorAll('.left-panel input').forEach(el=>{
  const saved = localStorage.getItem(el.id); 
  if(saved) el.value = saved;
  el.addEventListener('input', ()=> {
    localStorage.setItem(el.id, el.value);
    set(ref(db, 'inputs/'+el.id), el.value);
  });
  // Firebase real-time sync
  onValue(ref(db, 'inputs/'+el.id), snapshot=>{
    if(snapshot.exists() && snapshot.val() !== el.value) el.value = snapshot.val();
  });
});

// --- Tab system ---
const tabButtons = document.querySelectorAll('.tab-btn');
const tabContent = document.getElementById('tabContent');

const tabData = {
  actions: `<div class="action-headers"><div>Name</div><div>Range</div><div>Hit</div><div>Damage type</div><div>Damage</div><div>Notes</div><div></div></div><div id="actionsContainer" style="flex:1;"></div><button id="addActionBtn">+ Add Action</button>`,
  spells: `<div class="action-headers"><div>Name</div><div>Range</div><div>Hit</div><div>Damage type</div><div>Damage</div><div>Notes</div><div></div></div><div id="spellsContainer" style="flex:1;"></div><button id="addSpellBtn">+ Add Spell</button>`,
  inventory: `<div id="inventoryContainer" style="flex:1; display:flex; flex-direction:column; gap:6px;"></div><button id="addInventoryBtn">+ Add Item</button>`,
  background: `<div class="bg-fields">
    <div class="stats-row"><div><label>Name</label><input id="bgName"></div><div><label>Race</label><input id="bgRace"></div></div>
    <div class="stats-row"><div><label>Class</label><input id="bgClass"></div><div><label>Gender</label><input id="bgGender"></div></div>
    <div class="stats-row"><div><label>Size</label><input id="bgSize"></div><div><label>Height</label><input id="bgHeight"></div></div>
    <div class="stats-row"><div><label>Faith</label><input id="bgFaith"></div><div><label>Age</label><input id="bgAge"></div></div>
    <div class="stats-row"><div><label>Weight</label><input id="bgWeight"></div><div><label>Languages</label><input id="bgLanguages"></div></div>
    <div class="bg-backstory"><label>Backstory</label><textarea id="bgBackstory" placeholder="Enter your backstory..." style="flex:1;"></textarea></div>
  </div>`
};

function switchTab(tab){
  tabContent.innerHTML = tabData[tab];
  tabButtons.forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add('active');

  if(tab==='actions') initActions();
  else if(tab==='spells') initSpells();
  else if(tab==='inventory') initInventory();
  else if(tab==='background') initBackground();
}

// --- Firebase + LocalStorage sync helpers ---
function syncInput(id){
  const el = document.getElementById(id);
  if(!el) return;
  const dbRef = ref(db, 'inputs/'+id);
  onValue(dbRef, snap=>{
    if(snap.exists() && snap.val() !== el.value) el.value = snap.val();
  });
  el.addEventListener('input', ()=> set(dbRef, el.value));
}

// --- Initialize tabs ---
function initBackground(){
  document.querySelectorAll('#tabContent input, #tabContent textarea').forEach(el=>{
    const saved = localStorage.getItem(el.id); if(saved) el.value = saved;
    el.addEventListener('input', ()=> {
      localStorage.setItem(el.id, el.value);
      set(ref(db, 'inputs/'+el.id), el.value);
    });
    syncInput(el.id);
  });
}

function initActions(){
  const container = document.getElementById('actionsContainer');
  const btn = document.getElementById('addActionBtn');
  const saved = JSON.parse(localStorage.getItem('actionsList')||'[]');
  container.innerHTML = '';
  saved.length ? saved.forEach(a=>container.appendChild(createActionSection(a))) : container.appendChild(createActionSection());
  btn.addEventListener('click', ()=>{
    container.appendChild(createActionSection());
    saveActions();
  });
  loadActionsFromFirebase();
}

function initSpells(){
  const container = document.getElementById('spellsContainer');
  const btn = document.getElementById('addSpellBtn');
  const saved = JSON.parse(localStorage.getItem('spellsList')||'[]');
  container.innerHTML = '';
  saved.length ? saved.forEach(s=>container.appendChild(createSpellSection(s))) : container.appendChild(createSpellSection());
  btn.addEventListener('click', ()=>{
    container.appendChild(createSpellSection());
    saveSpells();
  });
  loadSpellsFromFirebase();
}

function initInventory(){
  const container = document.getElementById('inventoryContainer');
  const btn = document.getElementById('addInventoryBtn');
  const saved = JSON.parse(localStorage.getItem('inventoryList')||'[]');
  container.innerHTML = '';
  saved.length ? saved.forEach(i=>container.appendChild(createInventorySection({name:i}))) : container.appendChild(createInventorySection());
  btn.addEventListener('click', ()=>{
    container.appendChild(createInventorySection());
    saveInventory();
  });
  loadInventoryFromFirebase();
}

// --- Firebase syncing for dynamic lists ---
function loadActionsFromFirebase(){
  const dbRef = ref(db,'actionsList');
  onValue(dbRef, snap=>{
    const data = snap.val();
    if(!data) return;
    const container = document.getElementById('actionsContainer');
    container.innerHTML = '';
    data.forEach(a=>container.appendChild(createActionSection(a)));
  });
}

function loadSpellsFromFirebase(){
  const dbRef = ref(db,'spellsList');
  onValue(dbRef, snap=>{
    const data = snap.val();
    if(!data) return;
    const container = document.getElementById('spellsContainer');
    container.innerHTML = '';
    data.forEach(s=>container.appendChild(createSpellSection(s)));
  });
}

function loadInventoryFromFirebase(){
  const dbRef = ref(db,'inventoryList');
  onValue(dbRef, snap=>{
    const data = snap.val();
    if(!data) return;
    const container = document.getElementById('inventoryContainer');
    container.innerHTML = '';
    data.forEach(i=>container.appendChild(createInventorySection({name:i})));
  });
}

// --- Tab buttons ---
tabButtons.forEach(btn => btn.addEventListener('click', ()=>switchTab(btn.dataset.tab)));
switchTab('actions'); // default
</script>
